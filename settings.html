<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Settings page for javascript game">
    <link rel="shortcut icon" href="./assets/favicon.ico" type="image/x-icon">
    <title>Settings</title>
    <link rel="stylesheet" href="./styles/body.css">
    <link rel="stylesheet" href="./styles/canvas.css">
    <style>
        body {
            background-color: #2f2f2f;
        }
    </style>
</head>

<body>
    <canvas id="myCanvas" width="1920" height="1080"></canvas>
    <script type="module" defer>
        import { Menu } from './scripts/Menu.js';

        const canvas = document.getElementById('myCanvas');
        /** @type {CanvasRenderingContext2D} */
        const ctx = canvas.getContext('2d');
        ctx.font = '42px sans-serif';
        ctx.fillStyle = 'white';
        const center = { x: 1920 * 0.5, y: 1080 * 0.5 };
        const titleString = 'Settings';
        const titleWidth = ctx.measureText(titleString).width * 0.5;
        const start = { x: 120, y: 126 };
        /** @type {Menu} */
        let pressedKeys = {};
        let lastFrame = 0;
        let column = 0;
        let menu = new Menu([
            `Move up: ${localStorage.getItem('up').split('|')[column]}`,
            `Move down: ${localStorage.getItem('down').split('|')[column]}`,
            `Move left: ${localStorage.getItem('left').split('|')[column]}`,
            `Move right: ${localStorage.getItem('right').split('|')[column]}`,
            `Volume up: ${localStorage.getItem('volumeUp')}`,
            `Volume down: ${localStorage.getItem('volumeDown')}`
        ])

        function KeysHandler(event) {
            const key = event.key.toLowerCase();
            pressedKeys[key] = event.type === 'keydown';
            // console.log(pressedKeys);
        }


        setInterval(window.requestAnimationFrame, 32, update);
        addEventListener('keyup', KeysHandler, false);
        addEventListener('keydown', KeysHandler, false);

        function updateMenu(timestamp) {
            if (!menu.moved) {
                if ((pressedKeys['arrowup'])) {
                    menu.moved = true;
                    menu.timestamp = timestamp;
                    menu.selectUp();
                    return;
                }
                if ((pressedKeys['arrowdown'])) {
                    menu.moved = true;
                    menu.timestamp = timestamp;
                    menu.selectDown();
                    return;
                }
                if (pressedKeys['enter']) {
                    console.log(`Clicked on ${menu.getSelectedItem()}`);
                    menu.rebindKey(menu.getSelectedItem());

                }
                if (pressedKeys['backspace']) {
                    // console.log(window.history);
                    if (window.history.length > 0)
                        window.history.back();
                    window.location.replace('./index.html');
                }
            } else if (timestamp - menu.timestamp >= 100) { // 100 ms delay after interaction
                menu.moved = false;
                return;
            }
        }



        function update(timestamp) {
            // console.log('update');
            let progress = timestamp - lastFrame;
            lastFrame = timestamp;
            updateMenu(timestamp);
            draw();
        }

        function draw() {
            ctx.clearRect(0, 0, 1920, 1080);
            menu.options.forEach(e => {
                ctx.fillText(e.string, start.x, start.y + e.place * 42);

                if (e.checked) {
                    // console.log(e);
                    ctx.lineWidth = 6;
                    ctx.strokeStyle = '#F2F2F2';

                    ctx.beginPath();
                    ctx.moveTo(start.x - 10, start.y - 21 + e.place * 42);
                    ctx.lineTo(start.x - 20, start.y - 21 + e.place * 42);
                    ctx.stroke();
                    // console.log(e.place, e.string);
                }
            });
            ctx.fillText(titleString, center.x - titleWidth, 42);
            ctx.fillText('click [backspace] to go back', 0, 1080 - 84);
        }

    </script>
</body>

</html>